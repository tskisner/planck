import numpy as np

from cgkit.cgtypes import *
import physcon

from dipole import SatelliteVelocity

import private

def deaberration(vec, obt, coord):
    satvel = SatelliteVelocity(coord).orbital_v(obt)
    return np.cross(vec, np.cross(vec, satvel/physcon.c))

def get_wobble_psi2(od, filename=None):
    """Reads psi2 wobble angle from file generated by Michele's standalone code"""
    if filename is None:
        filename = private.WOBBLE['psi2_file']


def wobble(od):

    R_psi1 = mat3.rotation(private.WOBBLE['psi1_ref'], vec3(0,0,1)).transpose()
    R_psi2 = mat3.rotation(private.WOBBLE['psi2_ref'], vec3(0,1,0)).transpose()

    psi2 = get_wobble_psi2(od)
    R_psi2T = mat3.rotation(psi2, vec3(0,1,0))

    wobble_rotation = R_psi1.transpose() * (R_psi2T * (R_psi2 * R_psi1))

    return wobble_rotation
