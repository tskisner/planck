import numpy as np

from cgkit.cgtypes import *
import physcon

from dipole import SatelliteVelocity

import private

def deaberration(vec, obt, coord):
    satvel = SatelliteVelocity(coord).orbital_v(obt)
    return np.cross(vec, np.cross(vec, satvel/physcon.c))

def get_wobble_psi2(obt, filename=None):
    """Reads psi2 wobble angle from file generated by Michele's standalone code"""
    if filename is None:
        filename = private.WOBBLE['psi2_file']

    w = np.loadtxt(filename, delimiter=',', skiprows=1)

    return np.radians(
                np.interp(obt, w[:,1]/2**16, w[:,2])/60.
            )

def wobble(obt, wobble_psi2_model=get_wobble_psi2):

    R_psi1 = mat3.rotation(private.WOBBLE['psi1_ref'], vec3(0,0,1)).transpose()
    R_psi2 = mat3.rotation(private.WOBBLE['psi2_ref'], vec3(0,1,0)).transpose()

    psi2 = wobble_psi2_model(obt)[0]
    R_psi2T = mat3.rotation(psi2, vec3(0,1,0))

    wobble_rotation = R_psi1.transpose() * (R_psi2T * (R_psi2 * R_psi1))

    return wobble_rotation
